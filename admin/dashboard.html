<!DOCTYPE html>
<html lang="en">
  Â 
  <head>
    Â  Â 
    <meta charset="UTF-8" />
    Â  Â 
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    Â  Â 
    <title>Admin Dashboard - E-Shop</title>
    Â  Â 
    <!-- General styles for the entire site (includes dark mode logic) -->
    Â  Â 
    <link rel="stylesheet" href="../css/style.css" />
    Â  Â 
    <!-- Specific styles for the admin dashboard -->
    Â  Â 
    <link rel="stylesheet" href="../css/admin-dashboard.css" />

    Â  Â 
    <!-- Bootstrap CSS CDN for responsive grid and basic components -->
    Â  Â 
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    Â  Â 
    <!-- Font Awesome for icons -->
    Â  Â 
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      xintegrity="sha512-..."
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    Â 
  </head>
  Â 
  <body>
    Â  Â 
    <!-- Header Section (consistent across site) -->
    Â  Â 
    <header class="site-header">
      Â  Â  Â 
      <div class="container header-inner">
        Â  Â  Â  Â 
        <h1 class="logo">ðŸ›’ E-Shop Admin</h1>
        Â  Â  Â  Â 
        <nav class="main-nav">
          Â  Â  Â  Â  Â  <a href="../index.html">Home</a> Â  Â  Â  Â  Â 
          <a href="../products.html">Products</a> Â  Â  Â  Â  Â 
          <a href="../cart.html">Cart</a> Â  Â  Â  Â  Â 
          <a href="dashboard.html" class="active">Admin Panel</a> Â  Â  Â  Â  Â 
          <!-- This link will dynamically change to "Logout" if logged in -->
          Â  Â  Â  Â  Â  <a href="../login.html" id="auth-link">Login</a> Â  Â  Â  Â 
        </nav>
        Â  Â  Â  Â 
        <!-- Theme Toggle Button -->
        Â  Â  Â  Â 
        <button id="theme-toggle" class="theme-button" title="Toggle Dark Mode">
          Â  Â  Â  Â  Â  ðŸŒ“ Â  Â  Â  Â 
        </button>
        Â  Â  Â 
      </div>
      Â  Â 
    </header>

    Â  Â 
    <!-- Main Content - Admin Dashboard -->
    Â  Â 
    <main class="container my-5">
      Â  Â  Â 
      <div class="d-flex justify-content-between align-items-center mb-4">
        Â  Â  Â  Â 
        <h1 class="dashboard-title">
          Â  Â  Â  Â  Â  Welcome, <span id="admin-name">Admin</span>! Â  Â  Â  Â 
        </h1>
        Â  Â  Â  Â 
        <button class="btn btn-outline-secondary" id="logout-btn">
          Â  Â  Â  Â  Â  <i class="fas fa-sign-out-alt me-2"></i>Logout Â  Â  Â  Â 
        </button>
        Â  Â  Â 
      </div>

      Â  Â  Â 
      <section class="dashboard-summary row mb-5 g-4">
        Â  Â  Â  Â 
        <!-- Total Users Summary Card -->
        Â  Â  Â  Â 
        <div class="col-lg-3 col-md-6">
          Â  Â  Â  Â  Â 
          <div class="summary-card card p-4 shadow-sm">
            Â  Â  Â  Â  Â  Â 
            <div class="d-flex justify-content-between align-items-center">
              Â  Â  Â  Â  Â  Â  Â 
              <div>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <h5 class="text-muted mb-2">Total Users</h5>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <p class="summary-value display-5" id="total-users">0</p>
                Â  Â  Â  Â  Â  Â  Â 
              </div>
              Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-users fa-3x text-primary"></i> Â  Â 
              Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â  Â 
            <a href="admin-users.html" class="card-link mt-3"
              >View All Users <i class="fas fa-arrow-circle-right"></i
            ></a>
            Â  Â  Â  Â  Â 
          </div>
          Â  Â  Â  Â 
        </div>
        Â  Â  Â  Â 
        <!-- Total Products Summary Card -->
        Â  Â  Â  Â 
        <div class="col-lg-3 col-md-6">
          Â  Â  Â  Â  Â 
          <div class="summary-card card p-4 shadow-sm">
            Â  Â  Â  Â  Â  Â 
            <div class="d-flex justify-content-between align-items-center">
              Â  Â  Â  Â  Â  Â  Â 
              <div>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <h5 class="text-muted mb-2">Total Products</h5>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <p class="summary-value display-5" id="total-products">0</p>
                Â  Â  Â  Â  Â  Â  Â 
              </div>
              Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-boxes fa-3x text-success"></i> Â  Â 
              Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â  Â 
            <a href="admin-products.html" class="card-link mt-3"
              >Manage Products <i class="fas fa-arrow-circle-right"></i
            ></a>
            Â  Â  Â  Â  Â 
          </div>
          Â  Â  Â  Â 
        </div>
        Â  Â  Â  Â 
        <!-- Pending Orders Summary Card -->
        Â  Â  Â  Â 
        <div class="col-lg-3 col-md-6">
          Â  Â  Â  Â  Â 
          <div class="summary-card card p-4 shadow-sm">
            Â  Â  Â  Â  Â  Â 
            <div class="d-flex justify-content-between align-items-center">
              Â  Â  Â  Â  Â  Â  Â 
              <div>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <h5 class="text-muted mb-2">Pending Orders</h5>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <p class="summary-value display-5" id="pending-orders">0</p>
                Â  Â  Â  Â  Â  Â  Â 
              </div>
              Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-clock fa-3x text-warning"></i> Â  Â 
              Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â  Â 
            <a href="admin-orders.html" class="card-link mt-3"
              >View Pending Orders <i class="fas fa-arrow-circle-right"></i
            ></a>
            Â  Â  Â  Â  Â 
          </div>
          Â  Â  Â  Â 
        </div>
        Â  Â  Â  Â 
        <!-- Total Revenue Summary Card -->
        Â  Â  Â  Â 
        <div class="col-lg-3 col-md-6">
          Â  Â  Â  Â  Â 
          <div class="summary-card card p-4 shadow-sm">
            Â  Â  Â  Â  Â  Â 
            <div class="d-flex justify-content-between align-items-center">
              Â  Â  Â  Â  Â  Â  Â 
              <div>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <h5 class="text-muted mb-2">Total Revenue</h5>
                Â  Â  Â  Â  Â  Â  Â  Â 
                <p class="summary-value display-5" id="total-revenue">$0.00</p>
                Â  Â  Â  Â  Â  Â  Â 
              </div>
              Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-dollar-sign fa-3x text-info"></i> Â 
              Â  Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â  Â 
            <a href="admin-orders.html" class="card-link mt-3"
              >View Sales Reports <i class="fas fa-arrow-circle-right"></i
            ></a>
            Â  Â  Â  Â  Â 
          </div>
          Â  Â  Â  Â 
        </div>
        Â  Â  Â 
      </section>

      Â  Â  Â 
      <section class="dashboard-links row g-4">
        Â  Â  Â  Â 
        <!-- User Management Link Card -->
        Â  Â  Â  Â 
        <div class="col-lg-4 col-md-6">
          Â  Â  Â  Â  Â 
          <a
            href="admin-users.html"
            class="management-card card p-4 shadow-sm text-decoration-none"
          >
            Â  Â  Â  Â  Â  Â 
            <div class="card-body text-center">
              Â  Â  Â  Â  Â  Â  Â 
              <i class="fas fa-user-cog fa-4x mb-3 text-secondary"></i> Â  Â  Â  Â 
              Â  Â  Â 
              <h4 class="card-title mb-0">User Management</h4>
              Â  Â  Â  Â  Â  Â  Â 
              <p class="card-text text-muted">
                Â  Â  Â  Â  Â  Â  Â  Â  Manage user accounts and roles. Â  Â  Â  Â  Â  Â  Â 
              </p>
              Â  Â  Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â 
          </a>
          Â  Â  Â  Â 
        </div>
        Â  Â  Â  Â 
        <!-- Product Catalog Link Card -->
        Â  Â  Â  Â 
        <div class="col-lg-4 col-md-6">
          Â  Â  Â  Â  Â 
          <a
            href="admin-products.html"
            class="management-card card p-4 shadow-sm text-decoration-none"
          >
            Â  Â  Â  Â  Â  Â 
            <div class="card-body text-center">
              Â  Â  Â  Â  Â  Â  Â 
              <i class="fas fa-box-open fa-4x mb-3 text-secondary"></i> Â  Â  Â  Â 
              Â  Â  Â 
              <h4 class="card-title mb-0">Product Catalog</h4>
              Â  Â  Â  Â  Â  Â  Â 
              <p class="card-text text-muted">Add, edit, or remove products.</p>
              Â  Â  Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â 
          </a>
          Â  Â  Â  Â 
        </div>
        Â  Â  Â  Â 
        <!-- Order Management Link Card -->
        Â  Â  Â  Â 
        <div class="col-lg-4 col-md-6">
          Â  Â  Â  Â  Â 
          <a
            href="admin-orders.html"
            class="management-card card p-4 shadow-sm text-decoration-none"
          >
            Â  Â  Â  Â  Â  Â 
            <div class="card-body text-center">
              Â  Â  Â  Â  Â  Â  Â 
              <i class="fas fa-clipboard-list fa-4x mb-3 text-secondary"></i> Â 
              Â  Â  Â  Â  Â  Â 
              <h4 class="card-title mb-0">Order Management</h4>
              Â  Â  Â  Â  Â  Â  Â 
              <p class="card-text text-muted">
                Â  Â  Â  Â  Â  Â  Â  Â  Track and update customer orders. Â  Â  Â  Â  Â  Â  Â 
              </p>
              Â  Â  Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â 
          </a>
          Â  Â  Â  Â  Â 
        </div>
        Â  Â  Â  Â 
        <!-- Site Settings Link Card (Placeholder) -->
        Â  Â  Â  Â 
        <div class="col-lg-4 col-md-6">
          Â  Â  Â  Â  Â 
          <a
            href="#"
            class="management-card card p-4 shadow-sm text-decoration-none"
          >
            Â  Â  Â  Â  Â  Â 
            <div class="card-body text-center">
              Â  Â  Â  Â  Â  Â  Â 
              <i class="fas fa-cogs fa-4x mb-3 text-secondary"></i> Â  Â  Â  Â  Â  Â 
              Â 
              <h4 class="card-title mb-0">Site Settings</h4>
              Â  Â  Â  Â  Â  Â  Â 
              <p class="card-text text-muted">
                Â  Â  Â  Â  Â  Â  Â  Â  Configure general site options. Â  Â  Â  Â  Â  Â  Â 
              </p>
              Â  Â  Â  Â  Â  Â 
            </div>
            Â  Â  Â  Â  Â 
          </a>
          Â  Â  Â  Â 
        </div>
        Â  Â  Â 
      </section>
      Â  Â 
    </main>

    Â  Â 
    <!-- Footer Section (consistent across site) -->
    Â  Â 
    <footer class="bg-dark text-white text-center py-4">
      Â  Â  Â 
      <div class="container">
        Â  Â  Â  Â 
        <p>&copy; 2024 E-Shop. All rights reserved.</p>
        Â  Â  Â  Â 
        <div class="social-links mt-3">
          Â  Â  Â  Â  Â 
          <a href="#" class="text-white mx-2"
            ><i class="fab fa-facebook-f"></i
          ></a>
          Â  Â  Â  Â  Â 
          <a href="#" class="text-white mx-2"><i class="fab fa-twitter"></i></a>
          Â  Â  Â  Â  Â 
          <a href="#" class="text-white mx-2"
            ><i class="fab fa-instagram"></i
          ></a>
          Â  Â  Â  Â 
        </div>
        Â  Â  Â  Â 
      </div>
      Â  Â  Â 
    </footer>

    Â  Â 
    <!-- Bootstrap JS Bundle (includes Popper.js) -->
    Â  Â 
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      xintegrity="sha384-..."
      crossorigin="anonymous"
    ></script>
    Â  Â 
    <!-- Custom site-wide JavaScript (e.g., theme toggle) -->
    Â  Â 
    <script src="../js/main.js"></script>
    Â  Â 
    <!-- Admin Dashboard specific JavaScript -->
    Â  Â 
    <script>
      // src/main/resources/static/admin/dashboard.html (inline script)
      document.addEventListener("DOMContentLoaded", async () => {
        const adminNameSpan = document.getElementById("admin-name");
        const logoutBtn = document.getElementById("logout-btn");
        const authLink = document.getElementById("auth-link"); // From header nav

        const API_BASE_URL = "https://e-shop-backend-8ouh.onrender.com/api"; // FIX: Corrected API endpoints to match backend @RequestMapping("/api/auth") and @GetMapping annotations
        const VALIDATE_ADMIN_URL = `${API_BASE_URL}/auth/admin/validate`;
        const ADMIN_DASHBOARD_STATS_URL = `${API_BASE_URL}/auth/admin/dashboard-stats`;
        /**
         * Retrieves the JWT token from local storage.
         * @returns {string|null} The JWT token or null if not found or is an empty string.
         */

        function getAuthToken() {
          const token = localStorage.getItem("jwt_token"); // Check if token exists, is a string, and is not an empty string after trimming whitespace
          if (token && typeof token === "string" && token.trim() !== "") {
            return token;
          }
          return null; // Return null if the token is effectively missing or empty
        }
        /**
         * Redirects the user to the login page after an optional alert.
         * Also clears any invalid JWT token from local storage.
         * @param {string} message Optional message to display before redirecting.
         */

        function redirectToLogin(
          message = "Session expired or unauthorized. Please log in."
        ) {
          alert(message); // Using alert, but custom modal is recommended for better UX
          localStorage.removeItem("jwt_token"); // Clear invalid token
          window.location.href = "../login.html"; // Redirect to login page
        }
        /**
         * Checks if the current user is an authenticated administrator.
         * @returns {boolean} True if the user is an admin, false otherwise.
         */

        const checkAdminAccess = async () => {
          const token = getAuthToken();
          if (!token) {
            redirectToLogin(
              "Access Denied! Please log in as an administrator."
            );
            return false;
          }

          try {
            console.log(
              "Attempting to validate admin access to:",
              VALIDATE_ADMIN_URL
            ); // DEBUG
            const response = await fetch(VALIDATE_ADMIN_URL, {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            console.log("Admin validation response status:", response.status); // DEBUG

            if (response.ok) {
              const userData = await response.json(); // Backend sends back user details including name and roles
              console.log("Admin validation successful. User data:", userData); // DEBUG
              if (userData.roles && userData.roles.includes("ROLE_ADMIN")) {
                adminNameSpan.textContent = userData.name || "Admin"; // Set admin name // Update header auth link state (handled by main.js, but re-confirm here)
                if (authLink) {
                  authLink.textContent = "Logout";
                  authLink.href = "#"; // Make logout link non-navigable directly // Ensure the main.js logout listener is attached or re-attached
                  if (!authLink._logoutListener) {
                    // Check if main.js already attached it
                    const newListener = (e) => {
                      // Define and store a new listener
                      e.preventDefault();
                      localStorage.removeItem("jwt_token");
                      alert("You have been logged out.");
                      window.location.href = "../login.html";
                    };
                    authLink.addEventListener("click", newListener);
                    authLink._logoutListener = newListener; // Store reference
                  }
                }
                return true;
              } else {
                console.warn(
                  "Admin validation successful, but user does not have ROLE_ADMIN:",
                  userData
                ); // DEBUG
              }
            } // If response not ok (e.g., 401, 403, 404), or not admin role after parsing
            redirectToLogin(
              "Access Denied! You do not have administrator privileges."
            );
            return false;
          } catch (error) {
            console.error("Error validating admin access:", error); // DEBUG
            // Attempt to read response text for more details if it's a network error or non-JSON
            if (response && !response.ok) {
              // Check if response object exists and is not ok
              try {
                const errorText = await response.text();
                console.error("Raw error response text:", errorText);
              } catch (textError) {
                console.error(
                  "Could not read response as text either:",
                  textError
                );
              }
            } else if (
              error instanceof TypeError &&
              error.message.includes("Failed to fetch")
            ) {
              console.error(
                "Possible network error or CORS issue. Check server status."
              );
            } else if (
              error instanceof SyntaxError &&
              error.message.includes("JSON")
            ) {
              console.error(
                "Response was not valid JSON. Backend might be returning HTML/plain text for error."
              );
            }
            redirectToLogin(
              "Session verification failed. Please log in again."
            );
            return false;
          }
        }; // Execute access check

        const isAdmin = await checkAdminAccess();
        if (!isAdmin) {
          return; // Stop execution if not admin
        } // --- Logout Functionality --- // This handles the dedicated logout button on the dashboard

        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("jwt_token"); // Clear token
          alert("You have been logged out."); // Using alert, but custom modal is recommended
          window.location.href = "../login.html"; // Redirect to login page
        }); // --- Fetch Summary Statistics --- // In a real application, you'd make AJAX calls to your Spring Boot backend // to fetch these numbers dynamically.

        const fetchDashboardStats = async () => {
          const token = getAuthToken();
          if (!token) return; // Should already be checked by checkAdminAccess

          try {
            console.log(
              "Attempting to fetch dashboard stats from:",
              ADMIN_DASHBOARD_STATS_URL
            ); // DEBUG
            const response = await fetch(ADMIN_DASHBOARD_STATS_URL, {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            });

            console.log("Dashboard stats response status:", response.status); // DEBUG

            if (!response.ok) {
              const errorData = await response.json(); // This might fail if response is not JSON
              throw new Error(
                errorData.message || "Failed to fetch dashboard stats."
              );
            }

            const stats = await response.json();
            console.log("Dashboard stats received:", stats); // DEBUG
            document.getElementById("total-users").textContent =
              stats.totalUsers !== undefined ? stats.totalUsers : "N/A";
            document.getElementById("total-products").textContent =
              stats.totalProducts !== undefined ? stats.totalProducts : "N/A";
            document.getElementById("pending-orders").textContent =
              stats.pendingOrders !== undefined ? stats.pendingOrders : "N/A";
            document.getElementById("total-revenue").textContent =
              stats.totalRevenue !== undefined
                ? `$${stats.totalRevenue.toFixed(2)}`
                : "$0.00";
          } catch (error) {
            console.error("Error fetching dashboard stats:", error); // DEBUG
            // Attempt to read response text for more details if it's a network error or non-JSON
            if (response && !response.ok) {
              // Check if response object exists and is not ok
              try {
                const errorText = await response.text();
                console.error("Raw error response text:", errorText);
              } catch (textError) {
                console.error(
                  "Could not read response as text either:",
                  textError
                );
              }
            } else if (
              error instanceof TypeError &&
              error.message.includes("Failed to fetch")
            ) {
              console.error(
                "Possible network error or CORS issue. Check server status."
              );
            } else if (
              error instanceof SyntaxError &&
              error.message.includes("JSON")
            ) {
              console.error(
                "Response was not valid JSON. Backend might be returning HTML/plain text for error."
              );
            } // Fallback to static data or display error
            document.getElementById("total-users").textContent = "N/A";
            document.getElementById("total-products").textContent = "N/A";
            document.getElementById("pending-orders").textContent = "N/A";
            document.getElementById("total-revenue").textContent = "$0.00";
            alert("Could not load dashboard statistics. Please try again.");
          }
        }; // Call to fetch stats after admin access is confirmed

        fetchDashboardStats();
      });
    </script>
    Â 
  </body>
</html>
